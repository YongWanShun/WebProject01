@model WebProject.Models.Post

@{
    ViewData["Title"] = Model.Title;
}

<div class="container mt-4">

    <!-- 文章標題 -->
    <h2 class="fw-bold">@Model.Title</h2>

    <hr />

    <!-- 作者與時間 -->
    <div class="text-muted mb-3">
        <span>
            作者：
            <strong>@Model.User?.Username</strong>
        </span>
        <span class="mx-2">|</span>
        <span>
            發布時間：
            @(Model.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "")
        </span>
    </div>

    <!-- 文章內容 -->
    <div class="post-content">
        @Html.Raw(Model.Content?.Replace("\n", "<br />"))
    </div>


    <hr />
    <!-- 評論區 -->
    <div class="comments-section mt-5">
        <h4 class="mb-4">評論區 (@(Model.Comments?.Count ?? 0))</h4>

        @if (Model.Comments != null && Model.Comments.Any())
        {
            @foreach (var comment in Model.Comments.Where(c => c.ParentId == null).OrderByDescending(c => c.CreatedAt))
            {
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center" style="width: 40px; height: 40px; font-size: 1.2rem;">
                            @comment.User?.Username?.Substring(0, 1).ToUpper()
                        </div>
                    </div>

                    <div class="flex-grow-1 ms-3">
                        <div class="fw-bold">
                            @comment.User?.Username
                            <span class="text-muted fw-normal small ms-2">@comment.CreatedAt?.ToString("yyyy-MM-dd HH:mm")</span>
                        </div>

                        <div class="mt-1">
                            @Html.Raw(comment.Content?.Replace("\n", "<br />"))
                        </div>

                        <div class="mt-1">
                            <button class="btn btn-sm btn-link text-decoration-none ps-0 text-muted" onclick="toggleReplyInput('@comment.CommentId')">
                                回覆
                            </button>
                        </div>

                        <div id="reply-input-@comment.CommentId" class="mt-2" style="display:none;">
                            <form asp-action="AddComment" method="post">
                                <input type="hidden" name="PostId" value="@Model.PostId" />
                                <input type="hidden" name="ParentId" value="@comment.CommentId" />
                                <div class="d-flex">
                                    <input name="Content" class="form-control form-control-sm me-2" placeholder="新增回覆..." required />
                                    <button type="submit" class="btn btn-sm btn-primary">留言</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="toggleReplyInput('@comment.CommentId')">取消</button>
                                </div>
                            </form>
                        </div>

                        @if (comment.InverseParent != null && comment.InverseParent.Any())
                        {
                            var replyCount = comment.InverseParent.Count;

                            <div class="mt-1">
                                <button class="btn btn-sm text-primary fw-bold text-decoration-none ps-0"
                                        onclick="toggleSubComments('sub-comments-@comment.CommentId', this, @replyCount)">
                                    <i class="bi bi-caret-down-fill"></i> @replyCount 條回覆
                                </button>
                            </div>

                            <div id="sub-comments-@comment.CommentId" style="display:none;">
                                @foreach (var reply in comment.InverseParent.OrderBy(r => r.CreatedAt))
                                {
                                    <div class="d-flex mt-3">
                                        <div class="flex-shrink-0">
                                            <div class="rounded-circle bg-light text-secondary d-flex justify-content-center align-items-center border" style="width: 30px; height: 30px; font-size: 0.8rem;">
                                                @reply.User?.Username?.Substring(0, 1).ToUpper()
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-2">
                                            <div class="fw-bold small">
                                                @reply.User?.Username
                                                <span class="text-muted fw-normal small ms-2">@reply.CreatedAt?.ToString("yyyy-MM-dd HH:mm")</span>
                                            </div>
                                            <div class="small mt-1">
                                                @Html.Raw(reply.Content?.Replace("\n", "<br />"))
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="alert alert-light text-center">還沒有人留言，來搶頭香吧！</div>
        }

        <div class="mt-4">
            <h5>發表留言</h5>
            @if (User.Identity.IsAuthenticated)
            {
                <form asp-action="AddComment" method="post">
                    <input type="hidden" name="PostId" value="@Model.PostId" />
                    <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                            <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center" style="width: 40px; height: 40px;">
                                @User.Identity.Name.Substring(0, 1).ToUpper()
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <textarea name="Content" class="form-control mb-2" rows="1" placeholder="新增留言..." required></textarea>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary btn-sm">留言</button>
                            </div>
                        </div>
                    </div>
                </form>
            }
            else
            {
                <p>請先 <a asp-controller="Users" asp-action="Login" data-bs-target=" #loginModal" data-bs-toggle="modal">登入</a> 才能參與討論。</p>
            }
        </div>
    </div>

    <div class="mt-4">
        <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">返回文章列表</a>
    </div>


</div>


@section Scripts {
    <script>
        // 控制「回覆輸入框」的開關
        function toggleReplyInput(id) {
            var box = document.getElementById('reply-input-' + id);
            if (box.style.display === 'none') box.style.display = 'block';
            else box.style.display = 'none';
        }

        // 控制「查看回覆」的開關
        function toggleSubComments(elementId, btn, count) {
            var container = document.getElementById(elementId);

            if (container.style.display === 'none') {
                // 展開
                container.style.display = 'block';
                // 按鈕變成「隱藏回覆」
                btn.innerHTML = '<i class="bi bi-caret-up-fill"></i> 隱藏回覆';
            } else {
                // 收起
                container.style.display = 'none';
                // 按鈕變回「查看 X 條回覆」
                btn.innerHTML = '<i class="bi bi-caret-down-fill"></i> ' + count + ' 條回覆';
            }
        }
    </script>
}